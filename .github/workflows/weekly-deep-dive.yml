name: Weekly Deep Dive

on:
  schedule:
    # 北京时间 周五 20:00（UTC 12:00）运行
    - cron: "0 12 * * 5"
  workflow_dispatch:

concurrency:
  group: weekly-deep-dive-${{ github.ref_name }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  weekly:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          clean: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run weekly deep dive (MCP-based)
        env:
          # 从远程存储拉取最近 7 天数据到本地 output（供周报生成读取）
          PULL_ENABLED: "true"
          PULL_DAYS: "7"

          # 周报 LLM 增强（可选）：启用后会在周报顶部追加一段“AI 研判摘要”
          WEEKLY_LLM_ENABLED: "true"

          # 周报热度排行榜（默认启用，可设为 false 关闭）
          WEEKLY_LEADERBOARD_ENABLED: "true"
          # external/internal（默认 external）；这里显式固定为 external
          WEEKLY_LEADERBOARD_SOURCE: "external"
          WEEKLY_EXTERNAL_LEADERBOARD_ENABLED: "true"
          WEEKLY_LEADERBOARD_TOP_N: "10"

          # 通用Webhook（用于推送周报 Markdown）
          GENERIC_WEBHOOK_URL: ${{ secrets.GENERIC_WEBHOOK_URL }}
          GENERIC_WEBHOOK_TEMPLATE: ${{ secrets.GENERIC_WEBHOOK_TEMPLATE }}

          # AI 模型配置（兼容你当前的 GEMINI_* secrets 命名）
          AI_API_KEY: ${{ secrets.AI_API_KEY || secrets.GEMINI_API_KEY }}
          AI_API_BASE: ${{ secrets.AI_API_BASE || secrets.GEMINI_BASE_URL }}
          AI_MODEL: ${{ secrets.AI_MODEL || secrets.GEMINI_MODEL || 'gemini-3-pro-preview' }}
          AI_REASONING_EFFORT: "high"

          # 远程存储配置
          S3_BUCKET_NAME: ${{ secrets.S3_BUCKET_NAME }}
          S3_ACCESS_KEY_ID: ${{ secrets.S3_ACCESS_KEY_ID }}
          S3_SECRET_ACCESS_KEY: ${{ secrets.S3_SECRET_ACCESS_KEY }}
          S3_ENDPOINT_URL: ${{ secrets.S3_ENDPOINT_URL }}
          S3_REGION: ${{ secrets.S3_REGION }}
          GITHUB_ACTIONS: true
        run: python scripts/weekly_digest.py

